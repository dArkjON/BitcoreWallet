name: Build Bitcore Wallet for iOS Altstore

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.0.1, etc.
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version number (e.g., 7.2.1)'
        required: false
        default: '7.2.1'
        type: string

jobs:
  build-ios-altstore:
    runs-on: macos-latest  # Use macOS for iOS compilation

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Node.js dependencies
      run: |
        npm install --production=false

    - name: Setup Ruby (for CocoaPods)
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'

    - name: Install CocoaPods
      run: |
        sudo gem install cocoapods
        pod --version

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Show Xcode and SDK information
      run: |
        echo "ðŸ”§ XCODE AND SDK INFORMATION"
        echo "============================="
        xcodebuild -version
        echo ""
        echo "ðŸ“± AVAILABLE IOS SDKS:"
        xcodebuild -showsdks
        echo ""
        echo "ðŸ”§ AVAILABLE SCHEMES:"
        cd ios
        xcodebuild -list -workspace BlueWallet.xcworkspace

    - name: Prepare iOS Environment
      run: |
        echo "ðŸ”§ PREPARING IOS BUILD ENVIRONMENT"
        echo "=================================="

        cd ios

        echo "ðŸ“ Current directory contents:"
        ls -la

        echo ""
        echo "ðŸ“‹ Checking iOS project structure:"

        # Check for workspace
        if [ -f "BlueWallet.xcworkspace/Contents.xcworkspacedata/xcschemes/BlueWallet.xcscheme" ]; then
          echo "âœ… Workspace and scheme found"
        elif [ -f "BlueWallet.xcodeproj/project.xcworkspace/contents.xcworkspacedata/xcschemes/BlueWallet.xcscheme" ]; then
          echo "âœ… Project scheme found"
        else
          echo "âŒ Scheme not found, but continuing anyway..."
          echo "ðŸ“ Available schemes:"
          find . -name "*.xcscheme" 2>/dev/null || echo "No schemes found"
        fi

        echo ""
        echo "ðŸ“‹ Checking for main files:"
        if [ -f "BlueWallet.xcodeproj/project.pbxproj" ]; then
          echo "âœ… Project file found"
        else
          echo "âŒ Project file missing"
        fi

        if [ -f "Podfile" ]; then
          echo "âœ… Podfile found"
        else
          echo "âŒ Podfile missing"
        fi

        echo ""
        echo "ðŸ”§ Attempting to list available schemes (with error handling):"

        # Try to list schemes safely
        if [ -d "BlueWallet.xcworkspace" ]; then
          echo "ðŸ“± Checking workspace schemes:"
          set +e
          xcodebuild -list -workspace BlueWallet.xcworkspace 2>&1 | head -20 || echo "âš ï¸ Workspace listing failed"
          set -e
        elif [ -d "BlueWallet.xcodeproj" ]; then
          echo "ðŸ“± Checking project schemes:"
          set +e
          xcodebuild -list -project BlueWallet.xcodeproj 2>&1 | head -20 || echo "âš ï¸ Project listing failed"
          set -e
        else
          echo "âŒ No Xcode project found"
        fi

        echo ""
        echo "ðŸŽ¯ Build preparation completed, continuing with build..."

    - name: Install iOS dependencies
      run: |
        echo "ðŸ”§ INSTALLING IOS DEPENDENCIES"
        echo "==============================="
        cd ios

        # Clean any existing pods
        rm -rf Pods/
        rm -f Podfile.lock

        # Install dependencies with verbose output
        pod install --repo-update --verbose

    - name: Validate Build Configuration
      run: |
        echo "ðŸ”§ VALIDATING BUILD CONFIGURATION"
        echo "================================="
        cd ios

        echo "âœ… Checking workspace exists:"
        ls -la BlueWallet.xcworkspace

        echo ""
        echo "âœ… Checking Pods directory:"
        ls -la Pods/

        echo ""
        echo "âœ… Checking export options:"
        ls -la ../scripts/ExportOptions-Altstore.plist

    - name: Create Altstore Export Options
      run: |
        echo "ðŸ”§ CREATING ALTSTORE EXPORT OPTIONS"
        echo "=================================="

        # Create export options specifically for Altstore
        cat > /tmp/altstore-export.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>teamID</key>
            <string></string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>destination</key>
            <string>export</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
            <key>codeSignIdentity</key>
            <string></string>
            <key>provisioningProfile</key>
            <string></string>
        </dict>
        </plist>
        EOF

        echo "âœ… Altstore export options created"

    - name: Build Archive (with comprehensive error handling)
      run: |
        echo "ðŸ”§ BUILDING IOS ARCHIVE"
        echo "======================="

        cd ios

        echo "ðŸ“± Building Bitcore Wallet archive..."
        echo "   Architecture: $(uname -m)"
        echo "   Xcode version: $(xcodebuild -version | head -1)"

        # Clean any existing archive
        rm -rf $RUNNER_TEMP/BitcoreWallet.xcarchive

        # Function to detect available schemes
        detect_schemes() {
          local project_type=$1
          local project_path=$2

          echo "ðŸ” Detecting schemes for $project_type..."
          xcodebuild -list $project_path 2>/dev/null | grep -A 10 "Schemes:" | grep -v "Schemes:" | grep -v "^$" | sed 's/^[[:space:]]*//' || echo "No schemes found"
        }

        # Function to try build with different configurations
        try_build() {
          local method=$1
          local xcode_args="$2"
          local scheme="$3"

          echo "ðŸ”„ Attempting build with $method using scheme: $scheme"

          set +e
          # Remove problematic Stickers extension temporarily
      if [ -d "Stickers" ]; then
        echo "ðŸ”„ Temporarily moving Stickers extension..."
        mv Stickers Stickers_disabled 2>/dev/null || true
      fi

      xcodebuild archive $xcode_args \
            -scheme "$scheme" \
            -configuration Release \
            -archivePath $RUNNER_TEMP/BitcoreWallet.xcarchive \
            -destination "platform=macOS,variant=Mac Catalyst" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ENABLE_BITCODE=NO \
            ONLY_ACTIVE_ARCH=NO \
            -allowProvisioningUpdates \
            PROVISIONING_PROFILE_SPECIFIER="" \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            2>&1 | tee $RUNNER_TEMP/build_${method}.log

      # Restore Stickers extension
      if [ -d "Stickers_disabled" ]; then
        echo "ðŸ”„ Restoring Stickers extension..."
        mv Stickers_disabled Stickers 2>/dev/null || true
      fi

          local exit_code=$?
          set -e

          echo "ðŸ“Š $method build exit code: $exit_code"

          if [ $exit_code -eq 0 ]; then
            echo "âœ… $method build successful!"
            return 0
          else
            echo "âŒ $method build failed (exit code $exit_code)"
            echo "ðŸ“‹ Last 50 lines of log:"
            tail -50 $RUNNER_TEMP/build_${method}.log
            echo ""
            echo "ðŸ” Searching for common error patterns:"
            grep -i -E "(error|failed|unable|cannot)" $RUNNER_TEMP/build_${method}.log | tail -10 || echo "No error patterns found"
            return 1
          fi
        }

        # Try different approaches
        BUILD_SUCCESS=0

        # Detect available schemes first
        if [ -d "BlueWallet.xcworkspace" ]; then
          echo "ðŸ“± Workspace found, detecting schemes..."
          WORKSPACE_SCHEMES=$(detect_schemes "workspace" "-workspace BlueWallet.xcworkspace")
          echo "Available workspace schemes: $WORKSPACE_SCHEMES"
        fi

        if [ -d "BlueWallet.xcodeproj" ]; then
          echo "ðŸ“± Project found, detecting schemes..."
          PROJECT_SCHEMES=$(detect_schemes "project" "-project BlueWallet.xcodeproj")
          echo "Available project schemes: $PROJECT_SCHEMES"
        fi

        # Common scheme names to try
        SCHEMES_TO_TRY=("BlueWallet" "BlueWallet" "bitcore-wallet" "BitcoreWallet" "ios" "app")

        # Attempt 1: Workspace build with different schemes
        if [ -d "BlueWallet.xcworkspace" ]; then
          echo "ðŸ“± Trying workspace builds..."
          for scheme in "${SCHEMES_TO_TRY[@]}"; do
            if echo "$WORKSPACE_SCHEMES" | grep -q "$scheme"; then
              echo "âœ… Found scheme '$scheme' in workspace"
              if try_build "workspace_$scheme" "-workspace BlueWallet.xcworkspace" "$scheme"; then
                BUILD_SUCCESS=1
                break
              fi
            fi
          done

          # If no scheme found, try with BlueWallet anyway
          if [ $BUILD_SUCCESS -eq 0 ]; then
            echo "âš ï¸ Trying workspace build with default scheme name..."
            if try_build "workspace_default" "-workspace BlueWallet.xcworkspace" "BlueWallet"; then
              BUILD_SUCCESS=1
            fi
          fi
        fi

        # Attempt 2: Project build with different schemes
        if [ $BUILD_SUCCESS -eq 0 ] && [ -d "BlueWallet.xcodeproj" ]; then
          echo "ðŸ“± Trying project builds..."
          for scheme in "${SCHEMES_TO_TRY[@]}"; do
            if echo "$PROJECT_SCHEMES" | grep -q "$scheme"; then
              echo "âœ… Found scheme '$scheme' in project"
              if try_build "project_$scheme" "-project BlueWallet.xcodeproj" "$scheme"; then
                BUILD_SUCCESS=1
                break
              fi
            fi
          done

          # If no scheme found, try with BlueWallet anyway
          if [ $BUILD_SUCCESS -eq 0 ]; then
            echo "âš ï¸ Trying project build with default scheme name..."
            if try_build "project_default" "-project BlueWallet.xcodeproj" "BlueWallet"; then
              BUILD_SUCCESS=1
            fi
          fi
        fi

        # Check if build was successful
        if [ $BUILD_SUCCESS -eq 1 ]; then
          echo "âœ… Archive build completed successfully!"
          echo "ðŸ“ Archive contents:"
          if [ -d "$RUNNER_TEMP/BitcoreWallet.xcarchive" ]; then
            ls -la $RUNNER_TEMP/BitcoreWallet.xcarchive/
            echo ""
            echo "ðŸ“‹ Archive structure:"
            find $RUNNER_TEMP/BitcoreWallet.xcarchive -name "*.app" | head -5
            echo ""
            echo "ðŸ“± App bundle contents:"
            find $RUNNER_TEMP/BitcoreWallet.xcarchive -name "*.app" -exec ls -la {} \;
          else
            echo "âŒ Archive directory not found despite success code"
            exit 1
          fi
        else
          echo "âŒ All build attempts failed"
          echo "ðŸ“‹ Available logs:"
          ls -la $RUNNER_TEMP/build_*.log 2>/dev/null || echo "No build logs found"

          # Show summary of all errors
          echo ""
          echo "ðŸš¨ ERROR SUMMARY:"
          echo "=================="
          for log in $RUNNER_TEMP/build_*.log; do
            if [ -f "$log" ]; then
              echo "ðŸ“„ $(basename $log):"
              grep -i -E "(error:|failed|unable|cannot)" "$log" | head -5 || echo "  No clear errors found"
              echo ""
            fi
          done

          exit 1
        fi

    - name: Export IPA (Unsigned)
      run: |
        echo "ðŸ”§ EXPORTING UNSIGNED IPA"
        echo "========================"

        cd ios

        # Ensure we have an archive
        if [ ! -d "$RUNNER_TEMP/BitcoreWallet.xcarchive" ]; then
          echo "âŒ No archive found, cannot export IPA"
          exit 1
        fi

        # Create build directory
        mkdir -p $RUNNER_TEMP/build

        # Export IPA using our custom export options
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/BitcoreWallet.xcarchive \
          -exportPath $RUNNER_TEMP/build \
          -exportOptionsPlist /tmp/altstore-export.plist \
          -allowProvisioningUpdates

        echo "âœ… IPA export completed"
        echo "ðŸ“ Build directory contents:"
        ls -la $RUNNER_TEMP/build/

    - name: Get Build Info
      id: build_info
      run: |
        IPA_PATH=$(find $RUNNER_TEMP/build -name "*.ipa" | head -n 1)

        if [ -z "$IPA_PATH" ]; then
          echo "âŒ No IPA found in build output"
          echo "ðŸ“ Build directory contents:"
          ls -la $RUNNER_TEMP/build/
          exit 1
        fi

        IPA_SIZE=$(stat -f%z "$IPA_PATH" 2>/dev/null || stat -c%s "$IPA_PATH")
        SHA256=$(shasum -a 256 "$IPA_PATH" | awk '{print $1}')
        VERSION=${{ github.ref_name || inputs.version }}

        echo "ðŸ“± IPA Path: $IPA_PATH"
        echo "ðŸ“ IPA Size: $IPA_SIZE bytes"
        echo "ðŸ” SHA256: $SHA256"
        echo "ðŸ·ï¸ Version: $VERSION"

        echo "IPA_PATH=$IPA_PATH" >> $GITHUB_OUTPUT
        echo "IPA_SIZE=$IPA_SIZE" >> $GITHUB_OUTPUT
        echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        name: Bitcore Wallet ${{ steps.build_info.outputs.VERSION }}
        body: |
          ## ðŸš€ Bitcore Wallet for iOS (Altstore Release)

          ### âœ¨ Features
          - **Full Bitcore (BTX) support** - Native BTX transactions and addresses
          - **Multiple wallet types** - Legacy, SegWit P2SH, SegWit Bech32, Taproot
          - **220-byte OP_RETURN** - Much larger than Bitcoin's 80 bytes
          - **Electrum Integration** - Connects to Bitcore Electrum servers
          - **No Developer Account Required** - Distributed via Altstore
          - **Self-Hosted** - Complete privacy and control

          ### ðŸ“± Altstore Installation
          1. Install Altstore on your iOS device
          2. Add this source in Altstore: `https://dArkjON.github.io/BitcoreWallet/source.json`
          3. Download and install the app
          4. 7-day certificate will auto-refresh

          ### ðŸ” Security
          - **Local Storage** - All private keys stored locally
          - **Encryption** - Wallet data encrypted with device passcode
          - **Biometric** - Face ID and Touch ID support
          - **No Tracking** - No analytics or tracking
          - **Open Source** - Fully auditable code

          ### ðŸ“‹ Build Information
          - **Version:** ${{ steps.build_info.outputs.VERSION }}
          - **Build Date:** ${{ github.event.head_commit.timestamp }}
          - **SHA256:** ${{ steps.build_info.outputs.SHA256 }}
          - **Size:** ${{ steps.build_info.outputs.IPA_SIZE }} bytes
          - **Build Type:** Unsigned (Altstore compatible)

          ### âš ï¸ Important Notes
          - **Unsigned IPA:** Must be signed through Altstore
          - **7-Day Expiration:** Apps auto-refresh via Altstore
          - **No App Store:** Distributed outside Apple's ecosystem

          ### ðŸ†šï¸ Supported Address Types
          - **P2PKH:** Starts with `3` (Bitcore prefix)
          - **P2SH:** Starts with prefix 0x7d (125)
          - **Bech32:** `btx1...` format
          - **OP_RETURN:** Up to 220 bytes support

        files: |
          ${{ steps.build_info.outputs.IPA_PATH }}
        draft: false
        prerelease: false

    - name: Update Altstore Source
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        # Create/update source.json for Altstore
        VERSION=${{ steps.build_info.outputs.VERSION }}
        IPA_URL="https://github.com/${{ github.repository }}/releases/download/$VERSION/BitcoreWallet.ipa"

        cat > source.json << EOF
        {
          "name": "Bitcore Wallet",
          "identifier": "io.bitcore.bitcorewallet",
          "apps": [
            {
              "name": "Bitcore Wallet",
              "bundleIdentifier": "io.bitcore.bitcorewallet",
              "developerName": "Bitcore Community",
              "version": "$VERSION",
              "versionDate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "versionDescription": "Bitcore wallet with BTX support and 220-byte OP_RETURN transactions - Distributed via Altstore without Apple Developer Account",
              "downloadURL": "$IPA_URL",
              "localizedDescription": "A powerful Bitcore (BTX) cryptocurrency wallet supporting all address types and advanced features like 220-byte OP_RETURN transactions. Built from the proven BlueWallet codebase and fully adapted for Bitcore network. Distributed via Altstore for maximum privacy and control.",
              "iconURL": "https://raw.githubusercontent.com/${{ github.repository }}/main/docs/icon-1024.png",
              "tintColor": "#FF9500",
              "size": ${{ steps.build_info.outputs.IPA_SIZE }},
              "permissions": [
                "Camera",
                "Photo Library",
                "Face ID",
                "Touch ID",
                "Notifications",
                "Microphone"
              ],
              "screenshotURLs": [
                "https://raw.githubusercontent.com/${{ github.repository }}/main/docs/screenshots/main.png",
                "https://raw.githubusercontent.com/${{ github.repository }}/main/docs/screenshots/wallet.png",
                "https://raw.githubusercontent.com/${{ github.repository }}/main/docs/screenshots/send.png"
              ],
              "news": [
                {
                  "title": "Bitcore Support Complete",
                  "identifier": "bitcore-support-complete",
                  "date": "2025-01-10T11:30:00Z",
                  "caption": "Full Bitcore (BTX) support with 220-byte OP_RETURN transactions and Altstore distribution"
                },
                {
                  "title": "No Developer Account Required",
                  "identifier": "no-apple-account",
                  "date": "2025-01-10T11:30:00Z",
                  "caption": "Distributed via Altstore - complete privacy and control"
                }
              ]
            }
          ]
        }
        EOF

        echo "âœ… Created source.json for Altstore"
        echo "ðŸ“² Source URL: https://dArkjON.github.io/BitcoreWallet/source.json"

    - name: Deploy to GitHub Pages
      if: startsWith(github.ref, 'refs/tags/')
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        keep_files: true
        destination_dir: ./
        allow_empty_commit: true

    - name: Build Summary
      run: |
        echo "## âœ… Bitcore Wallet Altstore Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Build Details:" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.build_info.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Size:** ${{ steps.build_info.outputs.IPA_SIZE }} bytes" >> $GITHUB_STEP_SUMMARY
        echo "- **SHA256:** ${{ steps.build_info.outputs.SHA256 }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“² Download:" >> $GITHUB_STEP_SUMMARY
        echo "- **GitHub Release:** https://github.com/${{ github.repository }}/releases" >> $GITHUB_STEP_SUMMARY
        echo "- **IPA File:** [BitcoreWallet.ipa](https://github.com/${{ github.repository }}/releases/download/v${{ steps.build_info.outputs.VERSION }}/BitcoreWallet.ipa)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“² Altstore Installation:" >> $GITHUB_STEP_SUMMARY
        echo "1. Install Altstore on iOS device" >> $GITHUB_STEP_SUMMARY
        echo "2. Add source: \`https://dArkjON.github.io/BitcoreWallet/source.json\`" >> $GITHUB_STEP_SUMMARY
        echo "3. Install Bitcore Wallet" >> $GITHUB_STEP_SUMMARY
        echo "4. 7-day auto-refresh enabled âœ¨" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ Your Bitcore Wallet is ready for Altstore distribution!"# Updated: Mon Nov 10 01:30:49 PM UTC 2025
