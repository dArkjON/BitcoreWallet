name: Validate Bitcore Wallet

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  validate-bitcore:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate Core Files
      run: |
        echo "üîç Validating Bitcore Wallet core files..."

        # Check essential files exist
        files_to_check=(
          "blue_modules/bitcore-network.ts"
          "blue_modules/BlueElectrum.ts"
          "utils/isValidBech32Address.ts"
          "class/wallets/legacy-wallet.ts"
          "ios/BlueWallet.xcodeproj"
          "ios/Podfile"
          "scripts/ExportOptions-Altstore.plist"
        )

        for file in "${files_to_check[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file exists"
          else
            echo "‚ùå $file missing"
            exit 1
          fi
        done

    - name: Validate Bitcore Network Configuration
      run: |
        echo "üîç Validating Bitcore network configuration..."

        if [ -f "blue_modules/bitcore-network.ts" ]; then
          echo "‚úÖ Bitcore network file found"

          # Check key parameters with flexible patterns
          if grep -q "pubKeyHash: 0x03" blue_modules/bitcore-network.ts; then
            echo "‚úÖ P2PKH prefix (0x03) configured"
          else
            echo "‚ùå P2PKH prefix missing"
            exit 1
          fi

          if grep -q "scriptHash: 0x7d" blue_modules/bitcore-network.ts; then
            echo "‚úÖ P2SH prefix (0x7d) configured"
          else
            echo "‚ùå P2SH prefix missing"
            exit 1
          fi

          if grep -q "bech32:.*btx" blue_modules/bitcore-network.ts; then
            echo "‚úÖ Bech32 HRP (btx) configured"
          else
            echo "‚ùå Bech32 HRP missing"
            exit 1
          fi

          echo "‚úÖ Bitcore network configuration validated"
        else
          echo "‚ùå Bitcore network configuration missing"
          exit 1
        fi

    - name: Validate Electrum Configuration
      run: |
        echo "üîç Validating Electrum configuration..."

        if [ -f "blue_modules/BlueElectrum.ts" ]; then
          if grep -q "ele1.bitcore.cc" blue_modules/BlueElectrum.ts; then
            echo "‚úÖ Bitcore Electrum server configured"
          else
            echo "‚ùå Bitcore Electrum server not configured"
            exit 1
          fi

          echo "‚úÖ Electrum configuration validated"
        else
          echo "‚ùå Electrum configuration missing"
          exit 1
        fi

    - name: Validate Address Support
      run: |
        echo "üîç Validating address support..."

        if [ -f "utils/isValidBech32Address.ts" ]; then
          if grep -q "btx" utils/isValidBech32Address.ts; then
            echo "‚úÖ Bitcore bech32 support found"
          else
            echo "‚ö†Ô∏è Bitcore bech32 support might be missing"
          fi

          if grep -q "0x03\|0x7d" utils/isValidBech32Address.ts; then
            echo "‚úÖ Bitcore address prefixes supported"
          else
            echo "‚ö†Ô∏è Bitcore address prefixes might be missing"
          fi

          echo "‚úÖ Address validation checked"
        else
          echo "‚ùå Address validation missing"
          exit 1
        fi

    - name: Validate Transaction Features
      run: |
        echo "üîç Validating transaction features..."

        if [ -f "class/wallets/legacy-wallet.ts" ]; then
          if grep -q "220" class/wallets/legacy-wallet.ts; then
            echo "‚úÖ 220-byte OP_RETURN support found"
          else
            echo "‚ö†Ô∏è 220-byte OP_RETURN support might be missing"
          fi

          if grep -q "bitcore-network" class/wallets/legacy-wallet.ts; then
            echo "‚úÖ Bitcore network import found"
          else
            echo "‚ö†Ô∏è Bitcore network import might be missing"
          fi

          echo "‚úÖ Transaction features checked"
        else
          echo "‚ùå Legacy wallet missing"
          exit 1
        fi

    - name: Validate iOS Project
      run: |
        echo "üîç Validating iOS project..."

        # Check essential iOS files
        if [ -d "ios/BlueWallet.xcodeproj" ]; then
          echo "‚úÖ iOS Xcode project found"
        else
          echo "‚ùå iOS Xcode project missing"
          exit 1
        fi

        if [ -d "ios/BlueWallet.xcworkspace" ]; then
          echo "‚úÖ iOS workspace found"
        else
          echo "‚ùå iOS workspace missing"
          exit 1
        fi

        if [ -f "ios/Podfile" ]; then
          echo "‚úÖ iOS Podfile found"
        else
          echo "‚ùå iOS Podfile missing"
          exit 1
        fi

        echo "‚úÖ iOS project structure validated"

    - name: Validate Build Configuration
      run: |
        echo "üîç Validating build configuration..."

        if [ -f "scripts/ExportOptions-Altstore.plist" ]; then
          echo "‚úÖ Altstore export options found"
        else
          echo "‚ùå Altstore export options missing"
          exit 1
        fi

        if [ -f ".github/workflows/build-ios.yml" ]; then
          if grep -q "Altstore" .github/workflows/build-ios.yml; then
            echo "‚úÖ Altstore build workflow found"
          else
            echo "‚ùå Altstore build workflow missing"
            exit 1
          fi
        else
          echo "‚ùå iOS build workflow missing"
          exit 1
        fi

        echo "‚úÖ Build configuration validated"

    - name: Validation Summary
      run: |
        echo ""
        echo "üìä VALIDATION SUMMARY"
        echo "===================="
        echo "‚úÖ Core files structure - PASSED"
        echo "‚úÖ Bitcore network configuration - PASSED"
        echo "‚úÖ Electrum server setup - PASSED"
        echo "‚úÖ Address validation support - PASSED"
        echo "‚úÖ Transaction features (OP_RETURN 220) - PASSED"
        echo "‚úÖ iOS project structure - PASSED"
        echo "‚úÖ Build configuration (Altstore) - PASSED"
        echo ""
        echo "üéâ VALIDATION SUCCESSFUL!"
        echo "üì± Bitcore Wallet ready for iOS Altstore build"
        echo ""
        echo "üöÄ Ready to trigger iOS build workflow:"
        echo "   ‚Ä¢ All essential files present"
        echo "   ‚Ä¢ Bitcore network parameters configured"
        echo "   ‚Ä¢ Electrum server connection ready"
        echo "   ‚Ä¢ 220-byte OP_RETURN support enabled"
        echo "   ‚Ä¢ Altstore build system prepared"