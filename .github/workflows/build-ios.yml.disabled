name: Build Bitcore Wallet for Altstore

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.0.1, etc.
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version number (e.g., 7.2.1)'
        required: false
        default: '7.2.1'
        type: string

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Setup Ruby (for CocoaPods)
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'

    - name: Install dependencies
      run: |
        # Install Node dependencies
        npm install

        # Install CocoaPods
        sudo gem install cocoapods

        # Install iOS dependencies
        cd ios
        pod install --repo-update
        cd ..

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Create temporary keychain
      run: |
        security create-keychain -p "" ~/Library/Keychains/build.keychain
        security default-keychain -s ~/Library/Keychains/build.keychain
        security unlock-keychain -p "" ~/Library/Keychains/build.keychain
        security set-keychain-settings ~/Library/Keychains/build.keychain

    - name: Configure Build
      env:
        VERSION: ${{ github.ref_name || inputs.version }}
        COMMIT_SHA: ${{ github.sha }}
        BUILD_DATE: ${{ github.event.head_commit.timestamp }}
      run: |
        # Update version info
        echo "Building Bitcore Wallet version: $VERSION"
        echo "Commit: $COMMIT_SHA"
        echo "Build date: $BUILD_DATE"

        # Create ExportOptions.plist with placeholder (will be updated below)
        cp scripts/ExportOptions.plist ios/ExportOptions.plist

    - name: Import Code Signing Certificate
      if: ${{ secrets.BUILD_CERTIFICATE_BASE64 != '' }}
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        KEYCHAIN_PASSWORD: ""
      run: |
        # Create variables
        CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

        # Import certificate
        echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode --output $CERTIFICATE_PATH
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH

    - name: Build Archive
      env:
        TEAM_ID: ${{ secrets.TEAM_ID }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        cd ios

        # Update ExportOptions.plist with actual values if available
        if [ -n "$TEAM_ID" ]; then
          /usr/libexec/PlistBuddy -c "Set :teamID $TEAM_ID" ExportOptions.plist
        fi

        if [ -n "$PROVISIONING_PROFILE" ]; then
          /usr/libexec/PlistBuddy -c "Set :provisioningProfiles:io.bitcore.bitcorewallet $PROVISIONING_PROFILE" ExportOptions.plist
        fi

        # Build archive
        xcodebuild archive \
          -workspace BlueWallet.xcworkspace \
          -scheme BlueWallet \
          -configuration Release \
          -archivePath $RUNNER_TEMP/BitcoreWallet.xcarchive \
          -destination generic/platform=iOS \
          -allowProvisioningUpdates \
          CODE_SIGN_STYLE=Automatic || true

        # Export IPA
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/BitcoreWallet.xcarchive \
          -exportPath $RUNNER_TEMP/build \
          -exportOptionsPlist ExportOptions.plist \
          -allowProvisioningUpdates

    - name: Get Build Info
      id: build_info
      run: |
        IPA_PATH=$(find $RUNNER_TEMP/build -name "*.ipa" | head -n 1)
        IPA_SIZE=$(stat -f%z "$IPA_PATH")
        SHA256=$(shasum -a 256 "$IPA_PATH" | awk '{print $1}')
        VERSION=${{ github.ref_name || inputs.version }}

        echo "IPA_PATH=$IPA_PATH" >> $GITHUB_OUTPUT
        echo "IPA_SIZE=$IPA_SIZE" >> $GITHUB_OUTPUT
        echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

        echo "IPA Path: $IPA_PATH"
        echo "IPA Size: $IPA_SIZE bytes"
        echo "SHA256: $SHA256"

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        name: Bitcore Wallet ${{ steps.build_info.outputs.VERSION }}
        body: |
          ## Bitcore Wallet for iOS

          ### ðŸš€ Features
          - Full Bitcore (BTX) support
          - Multiple wallet types (Legacy, SegWit, Taproot)
          - 220-byte OP_RETURN support
          - Connects to Bitcore Electrum servers

          ### ðŸ“± Installation
          1. Install Altstore on your iOS device
          2. Add this source in Altstore: `https://bitcore-wallet.github.io/BitcoreWallet/source.json`
          3. Download and install the app

          ### ðŸ” Security
          - Self-hosted, no tracking
          - Open source
          - Locally encrypted storage

          ### ðŸ“‹ Build Info
          - **Version:** ${{ steps.build_info.outputs.VERSION }}
          - **Build Date:** ${{ github.event.head_commit.timestamp }}
          - **SHA256:** ${{ steps.build_info.outputs.SHA256 }}
          - **Size:** ${{ steps.build_info.outputs.IPA_SIZE }} bytes

          ### âš ï¸ Note
          This app is signed for 7 days and will need to be refreshed through Altstore.
        files: |
          ${{ steps.build_info.outputs.IPA_PATH }}
        draft: false
        prerelease: false

    - name: Update Altstore Source
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        # Create/update source.json for Altstore
        VERSION=${{ steps.build_info.outputs.VERSION }}
        IPA_URL="https://github.com/${{ github.repository }}/releases/download/$VERSION/BitcoreWallet.ipa"

        cat > source.json << EOF
        {
          "name": "Bitcore Wallet",
          "identifier": "io.bitcore.bitcorewallet",
          "apps": [
            {
              "name": "Bitcore Wallet",
              "bundleIdentifier": "io.bitcore.bitcorewallet",
              "developerName": "Bitcore Community",
              "version": "$VERSION",
              "versionDate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "versionDescription": "Bitcore wallet with BTX support and 220-byte OP_RETURN transactions",
              "downloadURL": "$IPA_URL",
              "localizedDescription": "A powerful Bitcore (BTX) cryptocurrency wallet supporting all address types and advanced features like 220-byte OP_RETURN transactions.",
              "iconURL": "https://raw.githubusercontent.com/${{ github.repository }}/main/docs/icon-1024.png",
              "tintColor": "#FF9500",
              "size": ${{ steps.build_info.outputs.IPA_SIZE }},
              "permissions": [
                "Camera",
                "Photo Library",
                "Face ID",
                "Touch ID",
                "Notifications"
              ],
              "screenshotURLs": [
                "https://raw.githubusercontent.com/${{ github.repository }}/main/docs/screenshots/main.png",
                "https://raw.githubusercontent.com/${{ github.repository }}/main/docs/screenshots/wallet.png"
              ]
            }
          ]
        }
        EOF

        echo "Created source.json:"
        cat source.json

    - name: Deploy to GitHub Pages
      if: startsWith(github.ref, 'refs/tags/')
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        keep_files: true
        destination_dir: ./
        allow_empty_commit: true

    - name: Update Downloads Badge
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        # Create a simple badge
        echo "ðŸ“± Latest Version: ${{ steps.build_info.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "â¬‡ï¸ Download: https://github.com/${{ github.repository }}/releases" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“² Altstore: https://bitcore-wallet.github.io/BitcoreWallet/source.json" >> $GITHUB_STEP_SUMMARY# Build trigger enabled
