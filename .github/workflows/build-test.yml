name: iOS Build Test

on:
  push:
    branches:
      - master  # Trigger on push to master branch

jobs:
  build-ios-test:
    runs-on: macos-latest  # Use macOS for iOS compilation

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Node.js dependencies
      run: |
        npm install --production=false

    - name: Setup Ruby (for CocoaPods)
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'

    - name: Install CocoaPods
      run: |
        sudo gem install cocoapods
        pod --version

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Prepare iOS Environment
      run: |
        echo "ðŸ”§ PREPARING IOS BUILD ENVIRONMENT"
        echo "=================================="
        cd ios

        # Remove problematic Stickers extension temporarily
        if [ -d "Stickers" ]; then
          echo "ðŸ”„ Temporarily moving Stickers extension..."
          mv Stickers Stickers_disabled || true
        fi

        echo "âœ… iOS Environment Ready"

    - name: Install iOS dependencies
      run: |
        echo "ðŸ”§ INSTALLING IOS DEPENDENCIES"
        echo "==============================="
        cd ios

        # Clean any existing pods
        rm -rf Pods/
        rm -f Podfile.lock

        # Install dependencies
        pod install --repo-update

  - name: Build Archive (Simplified)
      run: |
        echo "ðŸ”§ BUILDING IOS ARCHIVE"
        echo "======================="
        cd ios

        echo "ðŸ“± Building Bitcore Wallet archive..."
        echo "   Architecture: $(uname -m)"
        echo "   Xcode version: $(xcodebuild -version | head -1)"

        # Clean any existing archive
        rm -rf $RUNNER_TEMP/BitcoreWallet.xcarchive

        # Try building with workspace
        xcodebuild archive \
          -workspace BlueWallet.xcworkspace \
          -scheme BlueWallet \
          -configuration Release \
          -archivePath $RUNNER_TEMP/BitcoreWallet.xcarchive \
          -destination "platform=macOS,variant=Mac Catalyst" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ENABLE_BITCODE=NO \
          ONLY_ACTIVE_ARCH=NO \
          -allowProvisioningUpdates \
          PROVISIONING_PROFILE_SPECIFIER="" \
          2>&1 | tee $RUNNER_TEMP/build.log

        BUILD_EXIT_CODE=$?
        echo "ðŸ“Š Build exit code: $BUILD_EXIT_CODE"

        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "âœ… Archive build successful!"
          echo "ðŸ“ Archive contents:"
          if [ -d "$RUNNER_TEMP/BitcoreWallet.xcarchive" ]; then
            ls -la $RUNNER_TEMP/BitcoreWallet.xcarchive/
            find $RUNNER_TEMP/BitcoreWallet.xcarchive -name "*.app" | head -5
            echo "ARCHIVE_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ Archive directory not found despite success code"
            exit 1
          fi
        else
          echo "âŒ Build failed (exit code $BUILD_EXIT_CODE)"
          echo "ðŸ“‹ Last 30 lines of log:"
          tail -30 $RUNNER_TEMP/build.log
          exit 1
        fi

    - name: Build Summary
      run: |
        echo "## âœ… iOS Build Test Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Build Results:" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Archive:** ${{ env.ARCHIVE_STATUS || 'Unknown' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ Test complete - check logs for details!"